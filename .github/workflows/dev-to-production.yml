############################ CONFIGURATION ####################################
name: ascension-dev-to-production

on:
  workflow_dispatch:

env:
  GITHUB_ACTIONS: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true
###############################################################################



############################ JOBS #############################################
jobs:
  ########################## MERGE DEV â†’ MAIN ################################
  merge_branch:
    runs-on: ubuntu-latest

    ######################## STEPS ############################################
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4.1.1
        with:
          token: ${{ steps.generate_token.outputs.token }}
          fetch-depth: 0
          ref: dev

      - name: Merge dev into main
        uses: everlytic/branch-merge@1.1.2
        with:
          github_token: ${{ steps.generate_token.outputs.token }}
          source_ref: dev
          target_branch: main
          commit_message_template: "merge: `{source_ref}` into `{target_branch}`"
  #############################################################################


  ########################## CREATE RELEASE TAG ################################
  create_tag:
    runs-on: ubuntu-latest
    needs: merge_branch

    ######################## STEPS ############################################
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout main
        uses: actions/checkout@v4.1.1
        with:
          token: ${{ steps.generate_token.outputs.token }}
          fetch-depth: 0
          ref: main

      - name: Compute next semantic version
        id: semver
        run: |
          LATEST=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
          if [ -z "$LATEST" ]; then
            NEXT="v0.1.0"
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "${LATEST#v}"
            NEXT="v${MAJOR}.${MINOR}.$((PATCH + 1))"
          fi
          echo "tag=$NEXT" >> "$GITHUB_OUTPUT"
          echo "Next tag: $NEXT"

      - name: Push new tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.semver.outputs.tag }}
          git push origin ${{ steps.semver.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
  #############################################################################


  ########################## MIRROR REPOSITORY ################################
  mirror_repository:
    runs-on: ubuntu-latest
    needs: merge_branch
    if: github.repository == 'Ascension-EIP/Ascension'

    ######################## STEPS ############################################
    steps:
      - name: Checkout main
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0
          ref: main

      - name: Mirror to external repository
        uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url: ${{ vars.MIRROR_REPOSITORY_URL }}
          ssh_private_key: ${{ secrets.MIRROR_SSH_KEY }}
  #############################################################################

###############################################################################
